name: FlyCI Wingman Auto-Apply Fixes

# This workflow automatically applies fixes suggested by FlyCI Wingman
# It monitors PR comments for Wingman suggestions, extracts patches, and applies them

on:
  issue_comment:
    types: [created]

jobs:
  auto-apply-fixes:
    name: Auto-Apply Wingman Fixes
    # Only run on PR comments from FlyCI Wingman bot
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, 'FlyCI Wingman') &&
      (contains(github.event.comment.body, '```diff') || contains(github.event.comment.body, '```patch'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
    
    steps:
    - name: Get PR details
      id: pr
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          core.setOutput('ref', pr.head.ref);
          core.setOutput('sha', pr.head.sha);
          core.setOutput('repo', pr.head.repo.full_name);
          return pr;
    
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.pr.outputs.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Extract and apply patches
      id: apply_patches
      env:
        COMMENT_BODY: ${{ github.event.comment.body }}
      run: |
        echo "Extracting patches from Wingman comment..."
        
        # Create temporary directory for patches
        mkdir -p /tmp/flyci-patches
        
        # Extract diff/patch blocks from the comment
        # This handles both ```diff and ```patch code blocks
        echo "$COMMENT_BODY" | awk '
          /```(diff|patch)/ { in_block=1; next }
          /```/ && in_block { in_block=0; next }
          in_block { print }
        ' > /tmp/flyci-patches/combined.patch
        
        # Check if we extracted any patches
        if [ ! -s /tmp/flyci-patches/combined.patch ]; then
          echo "No patches found in comment"
          echo "has_patches=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Patches extracted successfully"
        echo "Patch content:"
        cat /tmp/flyci-patches/combined.patch
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Try to apply the patch
        if git apply --check /tmp/flyci-patches/combined.patch 2>&1; then
          echo "Patch validation successful, applying..."
          git apply /tmp/flyci-patches/combined.patch
          
          # Check if there are changes to commit
          if git diff --quiet; then
            echo "No changes after applying patch"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected, will commit"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "has_patches=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "Patch application failed, trying with --reject to see details..."
          git apply --reject /tmp/flyci-patches/combined.patch 2>&1 || true
          echo "patch_failed=true" >> $GITHUB_OUTPUT
          echo "has_patches=true" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Commit and push changes
      if: steps.apply_patches.outputs.has_changes == 'true'
      run: |
        git add -A
        git commit -m "Apply FlyCI Wingman suggested fixes
        
        Automatically applied fixes suggested by FlyCI Wingman.
        Original comment: ${{ github.event.comment.html_url }}"
        
        git push origin ${{ steps.pr.outputs.ref }}
        echo "Changes committed and pushed successfully"
    
    - name: Trigger workflow re-run
      if: steps.apply_patches.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          // Get the latest workflow runs for this PR
          const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            event: 'pull_request',
            status: 'completed',
            head_sha: '${{ steps.pr.outputs.sha }}'
          });
          
          // Find failed workflow runs
          const failedRuns = workflowRuns.workflow_runs.filter(run => 
            run.conclusion === 'failure' && 
            run.head_sha === '${{ steps.pr.outputs.sha }}'
          );
          
          if (failedRuns.length > 0) {
            console.log(`Found ${failedRuns.length} failed workflow runs`);
            
            // Re-run the most recent failed workflow
            const runToRerun = failedRuns[0];
            console.log(`Re-running workflow: ${runToRerun.name} (ID: ${runToRerun.id})`);
            
            try {
              await github.rest.actions.reRunWorkflow({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runToRerun.id
              });
              console.log('Workflow re-run triggered successfully');
            } catch (error) {
              console.log(`Could not re-run workflow: ${error.message}`);
              console.log('The workflow will run automatically on the next push');
            }
          } else {
            console.log('No failed workflows found to re-run');
          }
    
    - name: Comment on success
      if: steps.apply_patches.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `‚úÖ **FlyCI Wingman fixes applied successfully!**
            
            The suggested fixes have been automatically applied and committed to this PR.
            
            üìù Commit: ${{ github.sha }}
            üîÑ CI checks will run automatically to verify the fixes.
            
            Original suggestion: ${{ github.event.comment.html_url }}`
          });
    
    - name: Comment on failure
      if: failure() && steps.apply_patches.outputs.patch_failed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `‚ö†Ô∏è **Failed to apply FlyCI Wingman fixes**
            
            The suggested patch could not be applied automatically. This might be due to:
            - Conflicts with recent changes in the PR
            - The patch format not being recognized
            - Files being modified since the suggestion was made
            
            Please review the suggestion and apply the changes manually:
            ${{ github.event.comment.html_url }}
            
            You can also try:
            1. Pulling the latest changes from the PR branch
            2. Manually applying the suggested changes
            3. Committing and pushing to trigger CI again`
          });
    
    - name: Comment on no patches
      if: steps.apply_patches.outputs.has_patches == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `‚ÑπÔ∏è **No patches found to apply**
            
            The comment was recognized as a FlyCI Wingman suggestion, but no valid diff/patch blocks were found.
            
            Please ensure the suggestion includes code blocks formatted as:
            \`\`\`diff
            ... patch content ...
            \`\`\`
            
            or
            
            \`\`\`patch
            ... patch content ...
            \`\`\`
            
            Original comment: ${{ github.event.comment.html_url }}`
          });
