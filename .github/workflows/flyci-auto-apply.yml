name: FlyCI Wingman Auto-Apply Fixes

# This workflow automatically applies fixes suggested by FlyCI Wingman
# It monitors PR comments for Wingman suggestions, extracts patches, and applies them

on:
  issue_comment:
    types: [created]

jobs:
  auto-apply-fixes:
    name: Auto-Apply Wingman Fixes
    # Only run on PR comments from FlyCI Wingman bot
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, 'FlyCI Wingman') &&
      (contains(github.event.comment.body, '```diff') || contains(github.event.comment.body, '```patch'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
    
    steps:
    - name: Get PR details
      id: pr
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          core.setOutput('ref', pr.head.ref);
          core.setOutput('sha', pr.head.sha);
          core.setOutput('repo', pr.head.repo.full_name);
          return pr;
    
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.pr.outputs.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Extract and apply patches
      id: apply_patches
      env:
        COMMENT_BODY: ${{ github.event.comment.body }}
      run: |
        echo "============================================"
        echo "Starting FlyCI Wingman patch extraction..."
        echo "============================================"
        echo "Comment ID: ${{ github.event.comment.id }}"
        echo "Comment URL: ${{ github.event.comment.html_url }}"
        echo "Comment Author: ${{ github.event.comment.user.login }}"
        echo ""
        
        # Create temporary directory for patches
        mkdir -p /tmp/flyci-patches
        
        # Extract diff/patch blocks from the comment
        # This handles both ```diff and ```patch code blocks
        echo "Extracting patch blocks from comment body..."
        echo "$COMMENT_BODY" | awk '
          /```(diff|patch)/ { in_block=1; next }
          /```/ && in_block { in_block=0; next }
          in_block { print }
        ' > /tmp/flyci-patches/combined.patch
        
        # Check if we extracted any patches
        if [ ! -s /tmp/flyci-patches/combined.patch ]; then
          echo "‚ùå No patches found in comment"
          echo "Comment body length: ${#COMMENT_BODY} characters"
          echo "Searched for: \`\`\`diff or \`\`\`patch blocks"
          echo "has_patches=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Log patch extraction statistics
        PATCH_SIZE=$(wc -c < /tmp/flyci-patches/combined.patch)
        PATCH_LINES=$(wc -l < /tmp/flyci-patches/combined.patch)
        PATCH_BLOCKS=$(echo "$COMMENT_BODY" | grep -c '```\(diff\|patch\)' || echo "0")
        
        echo "‚úÖ Patch extraction successful!"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üìä Patch Statistics:"
        echo "  ‚Ä¢ Total patch blocks found: $PATCH_BLOCKS"
        echo "  ‚Ä¢ Combined patch size: $PATCH_SIZE bytes"
        echo "  ‚Ä¢ Total lines in patch: $PATCH_LINES"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        echo "üìù Patch content preview (first 50 lines):"
        echo "-------------------------------------------"
        head -n 50 /tmp/flyci-patches/combined.patch
        echo "-------------------------------------------"
        echo ""
        
        # Configure git
        echo "‚öôÔ∏è  Configuring git..."
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        echo "Git configured successfully"
        echo ""
        
        # Validate and apply the patch
        echo "üîç Validating patch before application..."
        VALIDATE_START=$(date +%s)
        
        if git apply --check /tmp/flyci-patches/combined.patch 2>&1; then
          VALIDATE_END=$(date +%s)
          VALIDATE_TIME=$((VALIDATE_END - VALIDATE_START))
          
          echo "‚úÖ Patch validation successful! (took ${VALIDATE_TIME}s)"
          echo ""
          echo "üì¶ Applying patch to working directory..."
          APPLY_START=$(date +%s)
          
          if git apply /tmp/flyci-patches/combined.patch 2>&1; then
            APPLY_END=$(date +%s)
            APPLY_TIME=$((APPLY_END - APPLY_START))
            echo "‚úÖ Patch applied successfully! (took ${APPLY_TIME}s)"
            echo ""
            
            # Check git status for changes
            echo "üîé Checking for changes in working directory..."
            git --no-pager status --short
            
            # Get detailed change statistics
            FILES_CHANGED=$(git diff --name-only | wc -l)
            LINES_ADDED=$(git diff --numstat | awk '{sum+=$1} END {print sum}')
            LINES_REMOVED=$(git diff --numstat | awk '{sum+=$2} END {print sum}')
            
            if git diff --quiet; then
              echo "‚ö†Ô∏è  No changes detected after applying patch"
              echo "This may indicate the patch was already applied or is empty"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üìä Change Statistics:"
              echo "  ‚Ä¢ Files changed: $FILES_CHANGED"
              echo "  ‚Ä¢ Lines added: $LINES_ADDED"
              echo "  ‚Ä¢ Lines removed: $LINES_REMOVED"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
              echo "üìã Modified files:"
              git diff --name-only | sed 's/^/  ‚Ä¢ /'
              echo ""
              echo "‚úÖ Changes ready to commit"
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "has_patches=true" >> $GITHUB_OUTPUT
              echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
              echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
              echo "lines_removed=$LINES_REMOVED" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Failed to apply patch (git apply command failed)"
            echo "patch_failed=true" >> $GITHUB_OUTPUT
            echo "has_patches=true" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          VALIDATE_END=$(date +%s)
          VALIDATE_TIME=$((VALIDATE_END - VALIDATE_START))
          
          echo "‚ùå Patch validation failed! (took ${VALIDATE_TIME}s)"
          echo ""
          echo "üîç Detailed error output:"
          echo "-------------------------------------------"
          git apply --check /tmp/flyci-patches/combined.patch 2>&1 || true
          echo "-------------------------------------------"
          echo ""
          echo "üîß Attempting to apply with --reject to see conflicts..."
          git apply --reject /tmp/flyci-patches/combined.patch 2>&1 || true
          echo ""
          echo "üìÅ Checking for .rej files (conflict markers)..."
          find . -name "*.rej" -exec echo "  ‚Ä¢ {}" \; -exec head -20 {} \; 2>/dev/null || echo "  No .rej files found"
          echo ""
          echo "patch_failed=true" >> $GITHUB_OUTPUT
          echo "has_patches=true" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Commit and push changes
      if: steps.apply_patches.outputs.has_changes == 'true'
      run: |
        echo "============================================"
        echo "Committing and pushing changes..."
        echo "============================================"
        echo ""
        
        COMMIT_START=$(date +%s)
        
        git add -A
        git commit -m "Apply FlyCI Wingman suggested fixes
        
        Automatically applied fixes suggested by FlyCI Wingman.
        Original comment: ${{ github.event.comment.html_url }}"
        
        COMMIT_END=$(date +%s)
        COMMIT_TIME=$((COMMIT_END - COMMIT_START))
        
        echo "‚úÖ Changes committed (took ${COMMIT_TIME}s)"
        echo ""
        echo "üìä Commit details:"
        git --no-pager log -1 --stat
        echo ""
        
        PUSH_START=$(date +%s)
        echo "üì§ Pushing to branch: ${{ steps.pr.outputs.ref }}"
        
        git push origin ${{ steps.pr.outputs.ref }}
        
        PUSH_END=$(date +%s)
        PUSH_TIME=$((PUSH_END - PUSH_START))
        
        echo "‚úÖ Changes pushed successfully! (took ${PUSH_TIME}s)"
        echo ""
        echo "üéâ Summary:"
        echo "  ‚Ä¢ Files changed: ${{ steps.apply_patches.outputs.files_changed }}"
        echo "  ‚Ä¢ Lines added: ${{ steps.apply_patches.outputs.lines_added }}"
        echo "  ‚Ä¢ Lines removed: ${{ steps.apply_patches.outputs.lines_removed }}"
        echo "  ‚Ä¢ Total time: $((COMMIT_TIME + PUSH_TIME))s"
        echo "============================================"
    
    - name: Trigger workflow re-run
      if: steps.apply_patches.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          // Get the latest workflow runs for this PR
          const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            event: 'pull_request',
            status: 'completed',
            head_sha: '${{ steps.pr.outputs.sha }}'
          });
          
          // Find failed workflow runs
          const failedRuns = workflowRuns.workflow_runs.filter(run => 
            run.conclusion === 'failure' && 
            run.head_sha === '${{ steps.pr.outputs.sha }}'
          );
          
          if (failedRuns.length > 0) {
            console.log(`Found ${failedRuns.length} failed workflow runs`);
            
            // Re-run the most recent failed workflow
            const runToRerun = failedRuns[0];
            console.log(`Re-running workflow: ${runToRerun.name} (ID: ${runToRerun.id})`);
            
            try {
              await github.rest.actions.reRunWorkflow({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runToRerun.id
              });
              console.log('Workflow re-run triggered successfully');
            } catch (error) {
              console.log(`Could not re-run workflow: ${error.message}`);
              console.log('The workflow will run automatically on the next push');
            }
          } else {
            console.log('No failed workflows found to re-run');
          }
    
    - name: Comment on success
      if: steps.apply_patches.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `‚úÖ **FlyCI Wingman fixes applied successfully!**
            
            The suggested fixes have been automatically applied and committed to this PR.
            
            üìù Commit: ${{ github.sha }}
            üîÑ CI checks will run automatically to verify the fixes.
            
            Original suggestion: ${{ github.event.comment.html_url }}`
          });
    
    - name: Comment on failure
      if: failure() && steps.apply_patches.outputs.patch_failed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `‚ö†Ô∏è **Failed to apply FlyCI Wingman fixes**
            
            The suggested patch could not be applied automatically. This might be due to:
            - Conflicts with recent changes in the PR
            - The patch format not being recognized
            - Files being modified since the suggestion was made
            
            Please review the suggestion and apply the changes manually:
            ${{ github.event.comment.html_url }}
            
            You can also try:
            1. Pulling the latest changes from the PR branch
            2. Manually applying the suggested changes
            3. Committing and pushing to trigger CI again`
          });
    
    - name: Comment on no patches
      if: steps.apply_patches.outputs.has_patches == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `‚ÑπÔ∏è **No patches found to apply**
            
            The comment was recognized as a FlyCI Wingman suggestion, but no valid diff/patch blocks were found.
            
            Please ensure the suggestion includes code blocks formatted as:
            \`\`\`diff
            ... patch content ...
            \`\`\`
            
            or
            
            \`\`\`patch
            ... patch content ...
            \`\`\`
            
            Original comment: ${{ github.event.comment.html_url }}`
          });
